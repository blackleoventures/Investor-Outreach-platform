# .github/workflows/cron-jobs.yml
# OPTIMIZED FOR FIREBASE BLAZE PLAN (Pay as you go)
#
# With Blaze plan, no Firebase read/write limits to worry about!
# Schedule: Every 15 minutes for faster email delivery
# Timeouts: Generous timeouts since we're processing more emails per run

name: Scheduled Cron Jobs

on:
  schedule:
    # Run every 30 minutes
    - cron: "*/30 * * * *"

  workflow_dispatch:
    # Allow manual triggering for testing
    inputs:
      job_type:
        description: "Which job to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - send-emails
          - check-replies
          - update-stats

env:
  # Production URL - hardcoded for reliability
  PRODUCTION_URL: https://investor-outreach-platform-roan.vercel.app

jobs:
  send-emails:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.job_type == 'all' || github.event.inputs.job_type == 'send-emails'
    steps:
      - name: Trigger Send Emails Cron
        run: |
          echo "Triggering Send Emails at $(date -u)"
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ env.PRODUCTION_URL }}/api/cron/send-emails" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 900)

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "Error: API returned $http_code"
            exit 1
          fi

  check-replies:
    runs-on: ubuntu-latest
    needs: send-emails
    if: always() && (github.event_name == 'schedule' || github.event.inputs.job_type == 'all' || github.event.inputs.job_type == 'check-replies')
    steps:
      - name: Trigger Check Replies Cron
        run: |
          echo "Triggering Check Replies at $(date -u)"
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ env.PRODUCTION_URL }}/api/cron/check-replies" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 600)

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "Error: API returned $http_code"
            exit 1
          fi

  update-stats:
    runs-on: ubuntu-latest
    needs: check-replies
    if: always() && (github.event_name == 'schedule' || github.event.inputs.job_type == 'all' || github.event.inputs.job_type == 'update-stats')
    steps:
      - name: Trigger Update Stats Cron
        run: |
          echo "Triggering Update Stats at $(date -u)"
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ env.PRODUCTION_URL }}/api/cron/update-stats" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 600)

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "Error: API returned $http_code"
            exit 1
          fi
