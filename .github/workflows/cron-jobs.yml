# .github/workflows/cron-jobs.yml
# FAANG OPTIMIZED - All jobs run in PARALLEL (no waiting)
#
# Schedule: Every 30 min, but each job has time-based skip logic
# - send-emails: Every 30 min (48x/day)
# - check-replies: Every 1 hour (24x/day)
# - update-stats: Every 2 hours (12x/day)

name: Scheduled Cron Jobs

on:
  schedule:
    # Run every 30 minutes
    - cron: "*/30 * * * *"

  workflow_dispatch:
    # Allow manual triggering for testing
    inputs:
      job_type:
        description: "Which job to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - send-emails
          - check-replies
          - update-stats

env:
  # Production URL - hardcoded for reliability
  PRODUCTION_URL: https://investor-outreach-platform-roan.vercel.app

jobs:
  # ============================================
  # SEND EMAILS - Every 30 min
  # ============================================
  send-emails:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.job_type == 'all' || github.event.inputs.job_type == 'send-emails'
    steps:
      - name: Trigger Send Emails Cron
        run: |
          echo "Triggering Send Emails at $(date -u)"
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ env.PRODUCTION_URL }}/api/cron/send-emails" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 900)

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "Error: API returned $http_code"
            exit 1
          fi

  # ============================================
  # CHECK REPLIES - Every 1 hour (runs in PARALLEL)
  # ============================================
  check-replies:
    runs-on: ubuntu-latest
    # NO needs: - runs independently in parallel!
    if: github.event_name == 'schedule' || github.event.inputs.job_type == 'all' || github.event.inputs.job_type == 'check-replies'
    steps:
      - name: Check if check-replies should run (every 1 hour)
        id: should_run
        run: |
          current_min=$(date -u +%M)
          # Only run at the start of each hour (0-30 min mark when cron fires)
          # Since cron runs at :00 and :30, this will trigger at :00 only
          if [[ "$current_min" -lt "15" ]] || [[ "${{ github.event.inputs.job_type }}" == "check-replies" ]] || [[ "${{ github.event.inputs.job_type }}" == "all" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Check Replies will run (minute: $current_min)"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping Check Replies (minute: $current_min, only runs at :00)"
          fi

      - name: Trigger Check Replies Cron
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "Triggering Check Replies at $(date -u)"
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ env.PRODUCTION_URL }}/api/cron/check-replies" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 600)

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "Error: API returned $http_code"
            exit 1
          fi

  # ============================================
  # UPDATE STATS - Every 2 hours (runs in PARALLEL)
  # ============================================
  update-stats:
    runs-on: ubuntu-latest
    # NO needs: - runs independently in parallel!
    if: github.event_name == 'schedule' || github.event.inputs.job_type == 'all' || github.event.inputs.job_type == 'update-stats'
    steps:
      - name: Check if update-stats should run (every 2 hours)
        id: should_run
        run: |
          current_hour=$(date -u +%H)
          current_min=$(date -u +%M)
          # Only run at even hours, at the :00 mark
          if [[ $((10#$current_hour % 2)) -eq 0 ]] && [[ "$current_min" -lt "15" ]] || [[ "${{ github.event.inputs.job_type }}" == "update-stats" ]] || [[ "${{ github.event.inputs.job_type }}" == "all" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Update Stats will run (hour: $current_hour, min: $current_min)"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping Update Stats (hour: $current_hour, only runs every 2 hours)"
          fi

      - name: Trigger Update Stats Cron
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "Triggering Update Stats at $(date -u)"
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ env.PRODUCTION_URL }}/api/cron/update-stats" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 600)

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "Error: API returned $http_code"
            exit 1
          fi
